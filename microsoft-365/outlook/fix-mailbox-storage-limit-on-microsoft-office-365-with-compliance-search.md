# üì© Fix Mailbox Storage Limit on Microsoft Office 365 with Compliance Search

{% hint style="info" %}
‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Send Mail ‡∏ö‡∏ô Outlook ‡∏à‡∏ô Storage Full ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Send Mail ‡πÑ‡∏î‡πâ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Clear Storage Mailbox ‡∏Å‡πà‡∏≠‡∏ô ‡∏ã‡∏∂‡πà‡∏á [Storage Limit](https://docs.microsoft.com/en-us/office365/servicedescriptions/exchange-online-service-description/exchange-online-limits) ‡∏à‡∏∞‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏° Microsoft Office 365 Plan ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 50 GB
{% endhint %}

{% hint style="danger" %}
**Cause** : ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î Storage Limit ‡∏ö‡∏ô Outlook ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ 3 ‡∏ß‡∏¥‡∏ò‡∏µ ‡∏Ñ‡∏∑‡∏≠ 1. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Export Data ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ 2. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Choose Office 365 Plan ‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ã‡∏∂‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πá‡∏à‡∏∞‡πÅ‡∏û‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ 3. ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Clear Storage Mailbox ‡∏î‡πâ‡∏ß‡∏¢ [Content Search](https://docs.microsoft.com/en-us/microsoft-365/compliance/content-search?view=o365-worldwide) ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Regular Expression ‡∏ú‡πà‡∏≤‡∏ô [Property](https://docs.microsoft.com/en-us/microsoft-365/compliance/keyword-queries-and-search-conditions?view=o365-worldwide) ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3 ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤
{% endhint %}

## **Configuration**

* ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö [https://protection.office.com](https://protection.office.com/)

<figure><img src="../../.gitbook/assets/mailbox-01.png" alt=""><figcaption></figcaption></figure>

* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Permissions -> eDiscovery Manager ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å Edit role group

<figure><img src="../../.gitbook/assets/mailbox-02.png" alt=""><figcaption></figcaption></figure>

* ‡∏Ñ‡∏•‡∏¥‡∏Å Choose eDiscovery Manager

<figure><img src="../../.gitbook/assets/mailbox-03.png" alt=""><figcaption></figcaption></figure>

* ‡∏Ñ‡∏•‡∏¥‡∏Å Add ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å Done

<figure><img src="../../.gitbook/assets/mailbox-04.png" alt=""><figcaption></figcaption></figure>

* ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Global Variable ‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Configuration.ps1

{% code overflow="wrap" %}
```
# O365
$Global:complianceuri = 'https://ps.compliance.protection.outlook.com/powershell-liveid/'
```
{% endcode %}

* ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Clear-Mailbox.ps1

```
. "$PSScriptRoot\Configuration.ps1"
Connect-ExchangeOnline -Credential $credential

$session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $url -Credential $credential -Authentication Basic -AllowRedirection

Import-PSSession -AllowClobber $session -DisableNameChecking

$storage = Get-Mailbox -Identity 'Natthasath Saksupanara' | Select-Object Displayname,
        @{Name='IssueWarningQuota (GB)';Expression={[Math]::Round($_.IssueWarningQuota.ToString().Split(‚Äù ‚Äú)[0], 0)}},
        @{Name='ProhibitSendQuota (GB)';Expression={[Math]::Round($_.ProhibitSendQuota.ToString().Split(‚Äù ‚Äú)[0], 0)}},
        @{Name='TotalItemSize (GB)';Expression={[Math]::Round(((Get-MailboxStatistics -identity $_.identity).TotalItemSize.ToString().Split(‚Äù ‚Äú)[0]),2)}},
        @{Name='ItemCount';Expression={[String]::join(";",((Get-MailboxStatistics -identity $_.identity).ItemCount))}}

$percent = [math]::Round(([double]$storage."TotalItemSize (GB)" / [double]$storage."ProhibitSendQuota (GB)") * 100, 1)

if ($percent -gt 80) {
    
        $folder = Get-MailboxFolderStatistics -Identity 'natthasath.sak@nida.ac.th' | Where-Object {$_.FolderPath -eq '/Sent Items'} | Select-Object FolderPath, FolderId, Identity
        $encoding= [System.Text.Encoding]::GetEncoding('us-ascii')
        $nibbler= $encoding.GetBytes('0123456789ABCDEF')
        $folderIdBytes = [Convert]::FromBase64String($folder."FolderId")
        $indexIdBytes = New-Object byte[] 48
        $indexIdIdx = 0
        $folderIdBytes | select -skip 23 -First 24 | %{$indexIdBytes[$indexIdIdx++]=$nibbler[$_ -shr 4];$indexIdBytes[$indexIdIdx++]=$nibbler[$_ -band 0xF]}
        $query = "folderid:$($encoding.GetString($indexIdBytes))"
        $search = New-ComplianceSearch -Name 'Delete Temp' -ExchangeLocation 'natthasath.sak@nida.ac.th' -ContentMatchQuery $query
        Start-ComplianceSearch -Identity $Search.Identity

        New-ComplianceSearchAction -SearchName 'Delete Temp' -Preview
        New-ComplianceSearchAction -SearchName 'Delete Temp' -Purge -PurgeType SoftDelete -Confirm:$false
    
}

Remove-PSSession $session
```

**‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°** :  [https://bit.ly/34adml6](https://bit.ly/34adml6), [http://bit.ly/3asDpYH](http://bit.ly/3asDpYH), [http://bit.ly/2Krt3xD](http://bit.ly/2Krt3xD)
